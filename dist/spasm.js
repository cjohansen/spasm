(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.spasm=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";function getLink(e){return e?"A"===e.tagName?e:getLink(e.parentNode):null}function monitorLinks(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:identity;return function(r){var n=getLink(r.target)||{};if(n.href&&1===r.which&&!r.ctrlKey&&!r.metaKey){var o=e.getLocation(n.href),u=o.host,i=o.port,a=o.page,c=""+u+(i&&80!==i?":"+i:"");!a||u&&c!==window.location.host?t(r,n):(r.preventDefault(),n.dataset.replace?e.replaceURL(n.href):e.gotoURL(n.href))}}}Object.defineProperty(exports,"__esModule",{value:!0});var _router=require("./src/router");Object.defineProperty(exports,"getURL",{enumerable:!0,get:function(){return _router.getURL}}),Object.defineProperty(exports,"toURLString",{enumerable:!0,get:function(){return _router.toURLString}}),Object.defineProperty(exports,"parseQueryString",{enumerable:!0,get:function(){return _router.parseQueryString}}),Object.defineProperty(exports,"match",{enumerable:!0,get:function(){return _router.match}}),Object.defineProperty(exports,"getLocation",{enumerable:!0,get:function(){return _router.getLocation}}),Object.defineProperty(exports,"parseRoute",{enumerable:!0,get:function(){return _router.parseRoute}}),Object.defineProperty(exports,"createRoute",{enumerable:!0,get:function(){return _router.createRoute}}),Object.defineProperty(exports,"createRoutes",{enumerable:!0,get:function(){return _router.createRoutes}}),Object.defineProperty(exports,"formatURL",{enumerable:!0,get:function(){return _router.formatURL}});var _spasm=require("./src/spasm");Object.defineProperty(exports,"createApp",{enumerable:!0,get:function(){return _spasm.createApp}}),exports.monitorLinks=monitorLinks;var identity=function(e){return e}},{"./src/router":4,"./src/spasm":5}],2:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+")");err.context=er;throw err}}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:args=Array.prototype.slice.call(arguments,1);handler.apply(this,args)}}else if(isObject(handler)){args=Array.prototype.slice.call(arguments,1);listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);if(typeof console.trace==="function"){console.trace()}}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-- >0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else if(listeners){while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction(evlistener))return 1;else if(evlistener)return evlistener.length}return 0};EventEmitter.listenerCount=function(emitter,type){return emitter.listenerCount(type)};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],3:[function(require,module,exports){exports.createAtom=function createAtom(val,options){var watchers={};var validator=options&&options.validator||function(){return true};function transition(next){if(!validator(next)){var err=new Error(next+" failed validation");err.name="AssertionError";throw err}var prev=val;val=next;Object.keys(watchers).forEach(function(k){watchers[k](k,atom,prev,next)})}var atom={addWatch:function(key,fn){watchers[key]=fn},removeWatch:function(key){delete watchers[key]},swap:function(fn){var args=[val].concat([].slice.call(arguments,1));transition(fn.apply(null,args))},reset:function(v){transition(v)},deref:function(){return val},toString:function(){return"Atom("+JSON.stringify(val)+")"}};return atom}},{}],4:[function(require,module,exports){"use strict";function first(r,t){for(var e=0,n=t.length;e<n;++e){var a=r(t[e]);if(a)return a}}function find(r,t){for(var e=0,n=t.length;e<n;++e)if(r(t[e]))return t[e]}function qualifyURL(r,t,e){var n=e.host,a=e.port,o=e.scheme;return r=""+(t.prefix||"")+r,n?(a&&(n=n.replace(/(:.*)?$/,":"+a)),(o||"http")+"://"+n.replace(/\/$/,"")+r):r}function formatURL(r){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r?toURLString({path:qualifyURL(r.paramNames.reduce(function(r,e){return r.replace(":"+e,t[e])},r.route),r,t),query:e}):null}function stripPrefix(r,t){if(t){var e=r.replace(new RegExp("^"+t),"");return e?e:"/"}return r}function getURL(r,t,e,n){return formatURL(find(function(r){return r.page===t},r),e,n)}function val(r){return!r||(/^-?\d+(\.\d+)?$/.test(r.trim())?parseFloat(r):r)}function paramValue(r){return/^-?\d+$/.test(r)?parseInt(r,10):/^-?\d+\.\d+$/.test(r)?parseFloat(r):r}function paramify(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return r.reduce(function(r,t){var e=_slicedToArray(t,2),n=e[0],a=e[1],o=paramValue("string"==typeof a?decodeURIComponent(a):a);return r[n]?(Array.isArray(r[n])||(r[n]=[r[n]]),r[n].push(o)):r[n]=o,r},{})}function toURLString(r){var t=r.query,e=r.path,n=Object.keys(t).map(function(r){return null===t[r]||void 0===t[r]?null:t[r]===!0?r:(Array.isArray(t[r])?t[r]:[t[r]]).map(function(t){return r+"="+encodeURIComponent(t)}).join("&")}).filter(function(r){return r}).join("&");return e+(n?"?"+n:"")}function parseQueryString(r){return paramify(r&&r.replace(/^\?/,"").split("&").map(function(r){return/=/.test(r)?r.split("="):[r,!0]})||[])}function match(r,t){var e=r.regexp,n=r.page,a=r.paramNames,o=r.prefix,u=t.split("#"),i=_slicedToArray(u,2),p=i[0],c=i[1],f=p.match(URL_RE),s=_slicedToArray(f,6),l=s[1],m=s[2],y=s[3],R=s[4],g=s[5],h=stripPrefix(R,o).match(e);return h?{page:n,url:p,path:R,host:m,hash:c,prefix:o||"",port:Number(y||80),scheme:l||"http",params:paramify(h.slice(1).map(function(r,t){return[a[t],r]})),query:parseQueryString(g)}:null}function getLocation(r,t){return first(function(r){return match(r,t)},r)||{params:{}}}function parseRoute(r){var t=(r.match(/:[a-zA-Z0-9-]+/g)||[]).map(function(r){return r.slice(1)});return{paramNames:t,route:r,regexp:new RegExp("^"+t.reduce(function(r,t){return r.replace(":"+t,"([^/?]+)")},r)+"$")}}function createRoute(r,t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=parseRoute(t);return n.page=r,n.prefix=e.prefix,n}function createRoutes(r,t){return r.map(function(r){var e=_slicedToArray(r,2),n=e[0],a=e[1];return createRoute(n,a,t||{})})}Object.defineProperty(exports,"__esModule",{value:!0});var _slicedToArray=function(){function r(r,t){var e=[],n=!0,a=!1,o=void 0;try{for(var u,i=r[Symbol.iterator]();!(n=(u=i.next()).done)&&(e.push(u.value),!t||e.length!==t);n=!0);}catch(r){a=!0,o=r}finally{try{!n&&i.return&&i.return()}finally{if(a)throw o}}return e}return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return r(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();exports.formatURL=formatURL,exports.getURL=getURL,exports.toURLString=toURLString,exports.parseQueryString=parseQueryString,exports.match=match,exports.getLocation=getLocation,exports.parseRoute=parseRoute,exports.createRoute=createRoute,exports.createRoutes=createRoutes;var URL_RE=/(?:(?:(https?):)?\/\/([^:\/]+)(?::(\d+))?)?([^\?]*)(?:\?(.*))?/},{}],5:[function(require,module,exports){"use strict";function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _toArray(e){return Array.isArray(e)?e:Array.from(e)}function createApp(e){function t(e,t,r){var n=deref(t);O("getData",n);var o=e.getData&&e.getData(n),a=++E;if(o&&o.then)return o.then(r);if(!(Array.isArray(o)&&o[0]&&o[0].then))return r(o);var i=function(){var e={isPartial:!0},t=0;return r(e),{v:Promise.all(o.map(function(n){return n.then(function(n){if(E===a)return t+=1,t===o.length&&delete e.isPartial,Object.keys(n||{}).forEach(function(t){return e[t]=n[t]}),r(e)})})).then(function(t){return P.emit("dataLoaded",e),t})}}();return"object"===("undefined"==typeof i?"undefined":_typeof(i))?i.v:void 0}function r(e,t,r){return e.prepareData?(O("prepareData",t),e.prepareData(t,r)):(O("No prepareData, using raw page data",t.pageData),t.pageData)}function n(e,t,r){return A?(O("finalizeData",e,t,r),A(e,t,r)):e||{}}function o(e){var t=n(r(R,deref(U),e),U.location,U.state.deref());return t.title&&(O("set page title",t.title),document.title=t.title),O("render",t),_(R.render,t),t}function a(e){U.state.swap(function(t){return Object.keys(e).reduce(function(t,r){return null===e[r]?delete t[r]:t[r]=e[r],t},t)})}function i(e){e.seedState&&a(e.seedState(deref(U))||{})}function u(e){return t(e,U,function(t){U.pageData=t,R=e,i(e);var r=o(["spasm:pageData"].concat(Object.keys(U.state.deref())));return Promise.resolve(r)})}function c(e){"function"==typeof e&&(e=e(U.state.deref())),a(e),P.emit("updateState",U.state.deref())}function f(e){var t=window.location.protocol+"//"+window.location.host;return e.indexOf(t)<0?""+t+e.replace(/^\/?/,"/"):e}function l(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};c(t);var r=(0,_router.getLocation)(S,f(e));return O("loadURL",e,r.page,r.params,r.query),U.location=r,u(j[r.page]||j[404])}function p(e){if(e){for(var t=_toArray(e),r=t[0],n=t.slice(1),o=arguments.length,a=Array(o>1?o-1:0),i=1;i<o;i++)a[i-1]=arguments[i];var u=n.concat(a),c=L.listeners(r);if(0===c.length)throw new Error("Tried to trigger action "+r+" ("+u+"), which has no handlers");return Promise.all(c.map(function(e){return e.apply(void 0,_toConsumableArray(u))}))}}function d(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return c(e),u(R)}function s(){return(0,_router.toURLString)(U.location)}function y(e){return R?o(e||[]):Promise.resolve()}function v(e){return c(e),y(Object.keys(e||{}))}function g(e){if(!R)throw new Error("Cannot update query params before a page is loaded");return U.location.query=e,history.pushState({},"",s()),d()}function h(e,t,r){var n=U.location&&j[U.location.page];return n&&n.canUnload&&n.canUnload(deref(U))===!1?y([]):(n&&n.onUnload&&c(n.onUnload(deref(U))||{}),history[r]({},"",e.replace(new RegExp("^("+D+")?"),D)),l(e,t))}var m,_=e.render,b=e.state,A=e.finalizeData,w=e.logger,D=e.prefix,P=new _events.EventEmitter,S=[],L=new _events.EventEmitter,j={};D=D||"";var U={state:(0,_jsAtom.createAtom)(b||{})},R=void 0,E=0,O="undefined"==typeof w?identity:function(){return w.log.apply(w,arguments)},k={};return m={loadURL:l,triggerAction:p,refresh:d,getCurrentURL:s,rerender:y,on:P.on.bind(P),once:P.once.bind(P),off:P.removeListener.bind(P),getURL:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return _router.getURL.apply(void 0,[S].concat(t))},addAction:function(e,t){L.on(e,function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.apply(void 0,[deref(U)].concat(r))})},performAction:function(e){return e?function(t){t&&t.preventDefault&&t.preventDefault(),p(e,t&&t.nativeEvent||t)}:null},addPage:function(e,t,r){S.push((0,_router.createRoute)(e,t,{prefix:D})),j[e]=r},start:function(){return window.onpopstate=function(){l(location.href)},l(location.href)},replaceURL:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return history.replaceState({},"",e.replace(new RegExp("^("+D+")?"),D)),l(e,t)},gotoURL:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return h(e,t,"pushState")}},_defineProperty(m,"replaceURL",function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return h(e,t,"replaceState")}),_defineProperty(m,"updateQueryParams",function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return c(t),g(Object.keys(e).reduce(function(t,r){return t[r]=e[r],t},U.location.query))}),_defineProperty(m,"clearQueryParams",function(){return g({})}),_defineProperty(m,"updateState",v),_defineProperty(m,"flashState",function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;c(e);var r=(new Date).getTime()+t;Object.keys(e).forEach(function(e){return k[e]=r}),setTimeout(function(){var e=(new Date).getTime();v(Object.keys(k).reduce(function(t,r){return k[r]<=e&&(t[r]=null,delete k[r]),t},{}))},t)}),_defineProperty(m,"getState",function(){return U.state.deref()}),_defineProperty(m,"getLocation",function(e){return e?(0,_router.getLocation)(S,f(e)):U.location}),_defineProperty(m,"getData",function(){return deref(U)}),m}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports.createApp=createApp;var _router=require("./router"),_events=require("events"),_jsAtom=require("js-atom"),identity=function(e){return e},deref=function(e){return{pageData:e.pageData,location:e.location,state:e.state.deref()}}},{"./router":4,events:2,"js-atom":3}]},{},[1])(1)});